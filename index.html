<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Nitro Type Top 1000 Racers (Full, unstreamlined, >1100 lines)
    =================================================================
    PURPOSE
    -------
    A fully integrated, explicit, and auditable leaderboard page for Nitro Type:
    - Preserves your original styling and structure
    - Renders: Leaderboard, Races Per Day, 24-Hour Changes, and Event (seasonal)
    - Robust JSON handling (preferred {updatedAt, racers} and legacy arrays)
    - Click-to-sort tables with asc/desc indicators and rank renumbering
    - Security-minded: HTML escaping, numeric safeguards, defensive parsing

    YOUR REQUESTS IMPLEMENTED
    -------------------------
    1) Static header text:
       - "Last updated: 8PM Daily"

    2) 24-Hour Changes:
       - Exclude Avg WPM and League Tier from tracking and display.
       - Filter out any entry where Δ Total Races >= 2600.
       - Exclude any racer with current total races (r.racesPlayed) == 0 from the 24-hour list.

    3) Event leaderboard:
       - Dropdown moved into the Event tab, uses theme colors, and is functional.
       - For "Back 2 School 2025", reads:
         Back2SchoolEvent2025_before.json  (the "before" / baseline snapshot)
         Back2SchoolEvent2025_after.json   (the "after"  / current snapshot)
       - Excludes Avg WPM and League Tier from tracking and display.
       - Excludes any racer with current total races == 0 from the event leaderboard.
       - Shows "Coming Soon" if the BEFORE file is empty or missing (no racers).

    4) Main Leaderboard + Races Per Day:
       - Preserved columns and behavior (username links, formatting, sorting).
       - Not modified to exclude total races 0 (your request was only for daily/event).

    5) Expandability:
       - Add more <option> elements in the Event tab dropdown with:
         data-before="YourEvent_before.json"
         data-after="YourEvent_after.json"
       - The code auto-fetches these and re-renders when selected.

    FILES TO HOST BESIDE THIS HTML
    ------------------------------
    - sample_data.json
    - sample_data_prev.json
    - Back2SchoolEvent2025_before.json
    - Back2SchoolEvent2025_after.json

    CODE ORGANIZATION
    -----------------
    - CSS: Theme variables, layout, table styles, responsive rules, and dropdown styles
    - HTML: Header, tabs, each section, and the event dropdown control block
    - JS:
      • Tab switching
      • Fetch helpers + payload normalization
      • Renderers: Leaderboard, Races Per Day, 24-Hour Changes (filtered), Event (filtered)
      • Sorting per table
      • Utilities: safeNumber, formatDeltaInt, escapeHTML, escapeAttr, parseLocalDate

    NOTES
    -----
    - Extensive comments are included for clarity and to meet the 1000+ lines request
    - All logic is explicit and auditable; no hidden side effects
  -->

  <meta charset="UTF-8" />
  <title>Nitro Type Top 1000 Racers</title>

  <style>
    /* ===================================================
       Root Color & Typography Variables
       =================================================== */
    :root {
      --bg-color:        #2a2a2a;  /* dark background */
      --panel-bg:        #333333;  /* panel background */
      --header-bg:       #3a3a3a;  /* header / tab background */
      --accent:          #b71c1c;  /* dark red accent */
      --accent-light:    #d32f2f;  /* lighter red on hover */
      --text-light:      #e0e0e0;  /* light text */
      --text-dim:        #bbbbbb;  /* secondary text */
      --font-family:     'Segoe UI', Tahoma, Verdana, sans-serif;
      --font-size-base:  1rem;     /* 16px */
      --font-size-lg:    2rem;     /* 32px */
      --font-size-md:    1.25rem;  /* 20px */
      --font-size-sm:    0.875rem; /* 14px */
      --transition:      0.3s ease;
    }

    /* ===================================================
       Global Reset & Base Styles
       =================================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      color: var(--text-light);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.5;
      overflow-x: hidden;
    }

    a {
      color: var(--accent);
      text-decoration: none;
      transition: color var(--transition);
    }
    a:hover {
      color: var(--accent-light);
    }

    /* ===================================================
       Header / Branding Styles
       =================================================== */
    header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
      background: var(--header-bg);
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    header h1 {
      font-size: var(--font-size-lg);
      margin-bottom: 8px;
      color: var(--accent);
    }
    header p {
      font-size: var(--font-size-md);
      color: var(--text-dim);
      margin: 4px 0;
    }
    header p a {
      font-weight: bold;
    }

    /* ===================================================
       Tabs
       =================================================== */
    .tabs {
      display: flex;
      justify-content: center;
      background: var(--header-bg);
      margin-bottom: 20px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .tabs .tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      cursor: pointer;
      font-size: var(--font-size-md);
      color: var(--text-light);
      transition: background var(--transition);
    }
    .tabs .tab:hover {
      background: var(--panel-bg);
    }
    .tabs .tab.active {
      background: var(--accent);
      color: #ffffff;
    }

    /* ===================================================
       Table Containers & Tables
       =================================================== */
    .table-container {
      display: none;
      background: var(--panel-bg);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 40px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .table-container.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: auto;
      font-size: var(--font-size-sm);
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--accent-light);
      color: #fff;
      font-weight: normal;
      padding: 12px;
      border-bottom: 2px solid var(--bg-color);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: pointer;
      user-select: none;
    }
    thead th.asc::after { content: ' ▲'; }
    thead th.desc::after { content: ' ▼'; }

    th, td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #444;
      vertical-align: middle;
    }

    tbody tr:nth-child(odd) { background: #3a3a3a; }
    tbody tr:nth-child(even) { background: #343434; }

    td a.profile-link {
      color: var(--accent);
      word-break: break-all;
      font-size: var(--font-size-sm);
    }
    td a.profile-link:hover { color: var(--accent-light); }

    /* ===================================================
       Responsive (Stacked Cards)
       =================================================== */
    @media (max-width: 900px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
      }
      td::before {
        content: attr(data-label);
        flex: 1 1 40%;
        color: var(--text-dim);
        font-weight: bold;
        text-transform: uppercase;
      }
      td span, td a, td div {
        flex: 1 1 60%;
        text-align: right;
      }
    }

    /* ===================================================
      Utilities
      =================================================== */
    .hidden { display: none !important; }
    .center { text-align: center; }
    .note {
      color: #e8e8e8;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 10px;
    }

    /* ===================================================
       Event Controls (dropdown inside Event tab)
       =================================================== */
    .event-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .event-controls label {
      color: var(--text-dim);
      font-size: var(--font-size-md);
    }
    .event-controls select {
      background: var(--header-bg);
      color: var(--text-light);
      border: 1px solid var(--accent);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: var(--font-size-md);
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--text-light) 50%),
        linear-gradient(135deg, var(--text-light) 50%, transparent 50%),
        linear-gradient(to right, var(--header-bg), var(--header-bg));
      background-position:
        calc(100% - 20px) calc(50% - 5px),
        calc(100% - 15px) calc(50% - 5px),
        calc(100% - 2.5em) 0.5em;
      background-size: 5px 5px, 5px 5px, 1px 1.8em;
      background-repeat: no-repeat;
      cursor: pointer;
    }
    .event-controls select:hover { border-color: var(--accent-light); }
    .event-controls select:focus {
      box-shadow: 0 0 0 2px rgba(211,47,47,0.3);
      border-color: var(--accent-light);
    }
  </style>
</head>

<body>
  <!-- ===================================================
       Header (static cadence per request)
       =================================================== -->
  <header>
    <h1>Nitro Type Top 1000 Racers</h1>
    <p>
      made by
      <a href="https://www.youtube.com/@InternetTyper" target="_blank">
        @InternetTyper on YouTube
      </a>
    </p>
    <p id="lastUpdated">Last updated: 8PM Daily</p>
    <p>Contact: azrael.for.god on Discord</p>
  </header>

  <!-- ===================================================
       Tabs
       =================================================== -->
  <div class="tabs">
    <div class="tab" data-target="leaderboardSection">Leaderboard</div>
    <div class="tab" data-target="racesPerDaySection">Races Per Day</div>
    <div class="tab active" data-target="changes24Section">24-Hour Changes</div>
    <div class="tab" data-target="eventSection">Event</div>
  </div>

  <!-- ===================================================
       Leaderboard Section
       =================================================== -->
  <section id="leaderboardSection" class="table-container">
    <table id="leaderboardTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Team Tag</th>
          <th>Title</th>
          <th>Total Races</th>
          <th>Avg WPM</th>
          <th>Top WPM</th>
          <th>Profile Views</th>
          <th>Member Since</th>
          <th>Garage Cars</th>
          <th>Profile URL</th>
          <th>Membership</th>
          <th>Nitros Used</th>
          <th>Longest Session</th>
          <th>League Tier</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       Races Per Day Section
       =================================================== -->
  <section id="racesPerDaySection" class="table-container">
    <table id="racesPerDayTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Total Races</th>
          <th>Days Active</th>
          <th>Races / Day</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       24-Hour Changes Section
       - Excludes Avg WPM & League Tier
       - Filters Δ Total Races >= 2600
       - Also excludes any racer whose current total races == 0
       =================================================== -->
  <section id="changes24Section" class="table-container active">
    <table id="changes24Table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th class="desc">Δ Total Races</th>
          <th>Δ Top WPM</th>
          <th>Δ Profile Views</th>
          <th>Δ Garage Cars</th>
          <th>Δ Nitros Used</th>
          <th>Δ Longest Session</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       Event Section (dropdown inside this tab)
       - Excludes Avg WPM & League Tier from tracking/display
       - Excludes racers whose current total races == 0
       - Shows "Coming Soon" if BEFORE file is empty or missing
       =================================================== -->
  <section id="eventSection" class="table-container">
    <div class="event-controls">
      <label for="eventSelector">Event:</label>
      <select id="eventSelector" aria-label="Select event to display">
        <!-- Expandable: add more <option> entries with data-before/data-after -->
        <option
          value="back2school2025"
          data-before="Back2SchoolEvent2025_before.json"
          data-after="Back2SchoolEvent2025_after.json"
        >
          Back 2 School 2025
        </option>
      </select>
      <span id="eventStatus" class="note hidden"></span>
    </div>

    <div id="eventComingSoon" class="note hidden">Coming Soon</div>

    <table id="eventTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th class="desc">Δ Total Races</th>
          <th>Δ Top WPM</th>
          <th>Δ Profile Views</th>
          <th>Δ Garage Cars</th>
          <th>Δ Nitros Used</th>
          <th>Δ Longest Session</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       JavaScript
       =================================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===================================================
      // Constants
      // ===================================================
      const MAX_24H_RACES = 2600; // exclude entries with Δ Total Races >= 2600

      // ===================================================
      // Tabs: Switch visible section by data-target
      // ===================================================
      const tabs = document.querySelectorAll('.tabs .tab');
      const sections = document.querySelectorAll('.table-container');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          sections.forEach(s => s.classList.remove('active'));
          tab.classList.add('active');
          const targetId = tab.dataset.target;
          const section = document.getElementById(targetId);
          if (section) section.classList.add('active');
        });
      });

      // ===================================================
      // Fetch main snapshots and render core tables
      //   - Supports both legacy array and { updatedAt, racers } shapes
      // ===================================================
      Promise.all([
        fetchJSON('sample_data.json'),
        fetchJSON('sample_data_prev.json', { allow404Empty: true })
      ])
      .then(([curData, prevData]) => {
        const cur = normalizeData(curData);
        const prev = normalizeData(prevData);

        // Build prev map keyed by lowercase username for quick lookup
        const prevMap = new Map(
          (prev.racers || []).map(r => [String(r.username || '').toLowerCase(), r])
        );

        // Render main sections
        renderLeaderboard(cur.racers);
        renderRacesPerDay(cur.racers);
        renderChanges24(cur.racers, prevMap);

        // Enable sorting behaviors on those tables
        enableSorting('leaderboardTable');
        enableSorting('racesPerDayTable');
        enableSorting('changes24Table');

        // After main renders, initialize Event tab (dropdown-driven)
        initEventTab();
      })
      .catch(err => {
        console.error('Failed loading main snapshots:', err);
        const msg = document.createElement('p');
        msg.textContent = 'Error loading main snapshots – check console.';
        msg.style.color = '#ff5252';
        msg.style.textAlign = 'center';
        document.body.appendChild(msg);

        // Even if main fails, still init Event tab to avoid dead UI
        initEventTab();
      });

      // ===================================================
      // Init Event tab: bind dropdown and render default selection
      // ===================================================
      function initEventTab() {
        const selector = document.getElementById('eventSelector');
        if (!selector) return;

        // Initial render on load
        renderEventForSelection(selector);

        // Re-render when selection changes (expandable)
        selector.addEventListener('change', () => renderEventForSelection(selector));

        // Enable sorting for event table (header click)
        enableSorting('eventTable');
      }

      // ===================================================
      // Render selected event by fetching before/after JSONs
      // - Excludes Avg WPM and League Tier
      // - Excludes racers whose current total races == 0
      // - Shows "Coming Soon" when BEFORE is empty/missing
      // ===================================================
      function renderEventForSelection(selector) {
        const selOption = selector.options[selector.selectedIndex];
        const beforeFile = selOption.getAttribute('data-before') || '';
        const afterFile  = selOption.getAttribute('data-after')  || '';

        const eventStatus = document.getElementById('eventStatus');
        if (eventStatus) {
          eventStatus.textContent = '';
          eventStatus.classList.add('hidden');
        }

        // Guard: if files missing on option
        if (!beforeFile || !afterFile) {
          showEventComingSoon(true);
          clearEventTable();
          return;
        }

        // Fetch both files with allow404Empty so UI doesn’t crash on missing files
        Promise.all([
          fetchJSON(beforeFile, { allow404Empty: true }),
          fetchJSON(afterFile,  { allow404Empty: true })
        ])
        .then(([prevEventData, curEventData]) => {
          const prevEvent = normalizeData(prevEventData);
          const curEvent  = normalizeData(curEventData);

          const prevHasData = Array.isArray(prevEvent.racers) && prevEvent.racers.length > 0;
          const curHasArray = Array.isArray(curEvent.racers);

          // If BEFORE has no data, we consider the event "Coming Soon"
          if (!prevHasData) {
            showEventComingSoon(true);
            clearEventTable();
            return;
          }

          showEventComingSoon(false);

          // Build prev map by username (lowercased)
          const prevEventMap = new Map(
            (prevEvent.racers || []).map(r => [String(r.username || '').toLowerCase(), r])
          );

          // Use current (after) racers array; filter out racers whose current total races == 0
          const currentRacersRaw = curHasArray ? (curEvent.racers || []) : [];

          // Hard filter: exclude racers whose current total races is 0
          const currentRacers = currentRacersRaw.filter(r => safeNumber(r.racesPlayed) > 0);

          // Render diffs (excludes Avg WPM and League Tier)
          renderEventChanges(currentRacers, prevEventMap);

          // Optional: emit status with counts
          if (eventStatus) {
            const beforeCount = (prevEvent.racers || []).length;
            const afterCount  = currentRacers.length;
            eventStatus.textContent = `Loaded ${beforeCount.toLocaleString()} (before) vs ${afterCount.toLocaleString()} (after).`;
            eventStatus.classList.remove('hidden');
          }
        })
        .catch(err => {
          console.error('Event fetch error:', err);
          showEventComingSoon(true);
          clearEventTable();

          if (eventStatus) {
            eventStatus.textContent = 'Error loading event data.';
            eventStatus.classList.remove('hidden');
          }
        });
      }

      // ===================================================
      // Helpers for Event UI visibility
      // ===================================================
      function showEventComingSoon(show) {
        const note = document.getElementById('eventComingSoon');
        const table = document.getElementById('eventTable');
        if (!note || !table) return;
        if (show) {
          note.classList.remove('hidden');
          table.classList.add('hidden');
        } else {
          note.classList.add('hidden');
          table.classList.remove('hidden');
        }
      }
      function clearEventTable() {
        const tbody = document.querySelector('#eventTable tbody');
        if (tbody) tbody.innerHTML = '';
      }

      // ===================================================
      // JSON fetch helper with optional empty fallback
      // ===================================================
      function fetchJSON(url, opts = {}) {
        const { allow404Empty = false } = opts;
        return fetch(url)
          .then(r => {
            if (!r.ok) {
              if (allow404Empty && (r.status === 404 || r.status === 204)) {
                return { racers: [] };
              }
              throw new Error(`${url}: HTTP ${r.status} - ${r.statusText}`);
            }
            return r.json();
          })
          .catch(err => {
            if (allow404Empty) return { racers: [] };
            throw err;
          });
      }

      // ===================================================
      // Normalize payloads:
      // - Preferred: { updatedAt, racers: [...] }
      // - Legacy:    [ ... ]
      // ===================================================
      function normalizeData(payload) {
        if (Array.isArray(payload)) {
          return { updatedAt: null, racers: payload };
        }
        if (payload && Array.isArray(payload.racers)) {
          return { updatedAt: payload.updatedAt || null, racers: payload.racers };
        }
        return { updatedAt: null, racers: [] };
      }

      // ===================================================
      // Render: Leaderboard
      // ===================================================
      function renderLeaderboard(data) {
        const sorted = [...data].sort((a, b) => safeNumber(b.racesPlayed) - safeNumber(a.racesPlayed));
        const tbody = document.querySelector('#leaderboardTable tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        sorted.forEach((r, idx) => {
          const tr = document.createElement('tr');

          const totalRaces   = safeNumber(r.racesPlayed).toLocaleString();
          const avgWPM       = safeNumber(r.avgSpeed).toLocaleString();
          const topWPM       = safeNumber(r.highestSpeed).toLocaleString();
          const profileViews = safeNumber(r.profileViews).toLocaleString();
          const garageCars   = safeNumber(r.garageCars).toLocaleString();
          const nitrosUsed   = safeNumber(r.nitrosUsed).toLocaleString();
          const longestSess  = safeNumber(r.longestSession).toLocaleString();
          const leagueTier   = safeNumber(r.leagueTier).toLocaleString();

          const username   = r.username || '';
          const teamTag    = r.tag || '';
          const title      = r.title || '';
          const joinDate   = r.joinDate || '';
          const membership = r.membership || '';
          const profileURL = r.profileURL || '#';

          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username">
              <a href="${escapeAttr(profileURL)}" target="_blank">${escapeHTML(username)}</a>
            </td>
            <td data-label="Team Tag">${escapeHTML(teamTag)}</td>
            <td data-label="Title">${escapeHTML(title)}</td>
            <td data-label="Total Races">${totalRaces}</td>
            <td data-label="Avg WPM">${avgWPM}</td>
            <td data-label="Top WPM">${topWPM}</td>
            <td data-label="Profile Views">${profileViews}</td>
            <td data-label="Member Since">${escapeHTML(joinDate)}</td>
            <td data-label="Garage Cars">${garageCars}</td>
            <td data-label="Profile URL">
              <a class="profile-link" href="${escapeAttr(profileURL)}" target="_blank">View Profile</a>
            </td>
            <td data-label="Membership">${escapeHTML(membership)}</td>
            <td data-label="Nitros Used">${nitrosUsed}</td>
            <td data-label="Longest Session">${longestSess}</td>
            <td data-label="League Tier">${leagueTier}</td>
          `.trim();

          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Render: Races Per Day
      // ===================================================
      function renderRacesPerDay(data) {
        const now = new Date();

        const list = data.map(r => {
          const joinDate = parseLocalDate(r.joinDate);
          const diffMs = now - joinDate;
          let daysActive = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          if (!Number.isFinite(daysActive) || daysActive < 1) daysActive = 1;

          const totalRaces = safeNumber(r.racesPlayed);
          const perDayRaw = totalRaces / daysActive;
          const perDayFmt = perDayRaw.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });

          return {
            username: r.username || '',
            profileURL: r.profileURL || '#',
            racesPlayed: totalRaces,
            daysActive: daysActive,
            racesPerDay: perDayRaw,
            formattedRacesPlayed: totalRaces.toLocaleString(),
            formattedDaysActive: daysActive.toLocaleString(),
            formattedPerDay: perDayFmt
          };
        });

        list.sort((a, b) => b.racesPerDay - a.racesPerDay);

        const tbody = document.querySelector('#racesPerDayTable tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        list.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username">
              <a href="${escapeAttr(r.profileURL)}" target="_blank">${escapeHTML(r.username)}</a>
            </td>
            <td data-label="Total Races">${r.formattedRacesPlayed}</td>
            <td data-label="Days Active">${r.formattedDaysActive}</td>
            <td data-label="Races / Day">${r.formattedPerDay}</td>
          `.trim();
          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Render: 24-Hour Changes
      // - Excludes Avg WPM & League Tier
      // - Filters Δ Total Races >= MAX_24H_RACES
      // - Excludes any racer with current total races == 0
      // ===================================================
      function renderChanges24(currentRacers, prevMap) {
        // First hard filter: exclude current racers with total races == 0
        const currentFiltered = (currentRacers || []).filter(r => safeNumber(r.racesPlayed) > 0);

        const diffs = currentFiltered
          .map(r => {
            const key = String(r.username || '').toLowerCase();
            const p = prevMap.get(key) || {};

            const dRaces = safeNumber(r.racesPlayed)    - safeNumber(p.racesPlayed);
            const dTop   = safeNumber(r.highestSpeed)   - safeNumber(p.highestSpeed);
            const dViews = safeNumber(r.profileViews)   - safeNumber(p.profileViews);
            const dCars  = safeNumber(r.garageCars)     - safeNumber(p.garageCars);
            const dNitro = safeNumber(r.nitrosUsed)     - safeNumber(p.nitrosUsed);
            const dSess  = safeNumber(r.longestSession) - safeNumber(p.longestSession);

            return {
              username:   r.username || '',
              profileURL: r.profileURL || '#',
              dRaces, dTop, dViews, dCars, dNitro, dSess
            };
          })
          .filter(d => d.dRaces < MAX_24H_RACES); // anomaly filter

        diffs.sort((a, b) => b.dRaces - a.dRaces);

        const tbody = document.querySelector('#changes24Table tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        diffs.forEach((d, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username"><a href="${escapeAttr(d.profileURL)}" target="_blank">${escapeHTML(d.username)}</a></td>
            <td data-label="Δ Total Races">${formatDeltaInt(d.dRaces)}</td>
            <td data-label="Δ Top WPM">${formatDeltaInt(d.dTop)}</td>
            <td data-label="Δ Profile Views">${formatDeltaInt(d.dViews)}</td>
            <td data-label="Δ Garage Cars">${formatDeltaInt(d.dCars)}</td>
            <td data-label="Δ Nitros Used">${formatDeltaInt(d.dNitro)}</td>
            <td data-label="Δ Longest Session">${formatDeltaInt(d.dSess)}</td>
          `.trim();
          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Render: Event Changes (Dropdown-driven)
      // - Excludes Avg WPM & League Tier
      // - Excludes current racers with total races == 0
      // - Sorted by Δ Total Races desc
      // ===================================================
      function renderEventChanges(currentRacers, prevMap) {
        const diffs = (currentRacers || []).map(r => {
          const key = String(r.username || '').toLowerCase();
          const p = prevMap.get(key) || {};

          const dRaces = safeNumber(r.racesPlayed)    - safeNumber(p.racesPlayed);
          const dTop   = safeNumber(r.highestSpeed)   - safeNumber(p.highestSpeed);
          const dViews = safeNumber(r.profileViews)   - safeNumber(p.profileViews);
          const dCars  = safeNumber(r.garageCars)     - safeNumber(p.garageCars);
          const dNitro = safeNumber(r.nitrosUsed)     - safeNumber(p.nitrosUsed);
          const dSess  = safeNumber(r.longestSession) - safeNumber(p.longestSession);

          return {
            username:   r.username || '',
            profileURL: r.profileURL || '#',
            dRaces, dTop, dViews, dCars, dNitro, dSess
          };
        });

        diffs.sort((a, b) => b.dRaces - a.dRaces);

        const tbody = document.querySelector('#eventTable tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        diffs.forEach((d, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username"><a href="${escapeAttr(d.profileURL)}" target="_blank">${escapeHTML(d.username)}</a></td>
            <td data-label="Δ Total Races">${formatDeltaInt(d.dRaces)}</td>
            <td data-label="Δ Top WPM">${formatDeltaInt(d.dTop)}</td>
            <td data-label="Δ Profile Views">${formatDeltaInt(d.dViews)}</td>
            <td data-label="Δ Garage Cars">${formatDeltaInt(d.dCars)}</td>
            <td data-label="Δ Nitros Used">${formatDeltaInt(d.dNitro)}</td>
            <td data-label="Δ Longest Session">${formatDeltaInt(d.dSess)}</td>
          `.trim();
          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Sorting: enableSorting(tableId)
      // - Click table headers to sort
      // - Numeric-aware; toggles asc/desc classes
      // - Renumbers Rank column
      // ===================================================
      function enableSorting(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const headers = table.querySelectorAll('th');

        headers.forEach((th, idx) => {
          th.addEventListener('click', () => {
            const tbody = table.querySelector('tbody');
            const rows  = Array.from(tbody.querySelectorAll('tr'));

            const asc = !th.classList.contains('asc');

            rows.sort((a, b) => {
              const aText = a.children[idx]?.textContent?.trim() ?? '';
              const bText = b.children[idx]?.textContent?.trim() ?? '';
              const aNum  = parseFloat(aText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
              const bNum  = parseFloat(bText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));

              if (!isNaN(aNum) && !isNaN(bNum)) {
                return asc ? aNum - bNum : bNum - aNum;
              }
              return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });

            headers.forEach(h => h.classList.remove('asc', 'desc'));
            th.classList.add(asc ? 'asc' : 'desc');

            rows.forEach((row, newIndex) => {
              if (row.children[0]) row.children[0].textContent = newIndex + 1;
            });

            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));
          });
        });
      }

      // ===================================================
      // Utilities
      // ===================================================
      function safeNumber(x) {
        const n = Number(x);
        return Number.isFinite(n) ? n : 0;
      }

      function formatDeltaInt(n) {
        const v = safeNumber(n);
        const sign = v > 0 ? '+' : v < 0 ? '' : '';
        return `${sign}${v.toLocaleString()}`;
      }

      function escapeHTML(s) {
        return String(s ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function escapeAttr(s) {
        return escapeHTML(s).replace(/"/g, '&quot;');
      }

      function parseLocalDate(input) {
        const raw = String(input || '').trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
          const [y, m, d] = raw.split('-').map(n => parseInt(n, 10));
          const dt = new Date(y, (m - 1), d, 0, 0, 0, 0);
          if (!isNaN(dt.getTime())) return dt;
        }
        const dt2 = new Date(raw);
        if (!isNaN(dt2.getTime())) return dt2;
        return new Date();
      }

      // End of DOMContentLoaded
    });
  </script>

</body>
</html>
