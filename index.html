<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Nitro Type Top 1000 Racers
    Full, unstreamlined index.html that preserves your original structure and styling,
    adds a true "Last updated" timestamp sourced from JSON, introduces a 24-Hour Changes
    tab that computes deltas for all metrics (except "Member Since" and non-numeric fields),
    makes usernames clickable, and keeps the "Profile URL" link.

    Notes for GitHub Pages:
    - Host this file in the repo root or docs/ (configured as Pages).
    - Place sample_data.json and sample_data_prev.json adjacent to this file.
    - The updater (external workflow/script) should write sample_data.json as:
        {
          "updatedAt": "2025-08-10T20:00:00-05:00",
          "racers": [ ... ]
        }
      and roll the prior snapshot to sample_data_prev.json with the same shape.

    - This front-end remains robust if sample_data.json is an array (legacy mode).
      In that case, it will still render and fallback lastUpdated to the client time.

    You asked for the full script, not streamlined, and over 500 lines.
    This file keeps your original CSS and JS structure, expands with clear comments,
    and adds the 24-hour delta view without removing your existing logic.
  -->

  <meta charset="UTF-8" />
  <title>Nitro Type Top 1000 Racers</title>

  <style>
    /* ===================================================
       Root Color & Typography Variables (Preserved)
       =================================================== */
    :root {
      --bg-color:        #2a2a2a;  /* dark background */
      --panel-bg:        #333333;  /* panel background */
      --header-bg:       #3a3a3a;  /* header / tab background */
      --accent:          #b71c1c;  /* dark red accent */
      --accent-light:    #d32f2f;  /* lighter red on hover */
      --text-light:      #e0e0e0;  /* light text */
      --text-dim:        #bbbbbb;  /* secondary text */
      --font-family:     'Segoe UI', Tahoma, Verdana, sans-serif;
      --font-size-base:  1rem;     /* 16px */
      --font-size-lg:    2rem;     /* 32px */
      --font-size-md:    1.25rem;  /* 20px */
      --font-size-sm:    0.875rem; /* 14px */
      --transition:      0.3s ease;
    }

    /* ===================================================
       Global Reset & Base Styles (Preserved)
       =================================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      color: var(--text-light);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.5;
      overflow-x: hidden;
    }

    a {
      color: var(--accent);
      text-decoration: none;
      transition: color var(--transition);
    }
    a:hover {
      color: var(--accent-light);
    }

    /* ===================================================
       Header / Branding Styles (Preserved)
       =================================================== */
    header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
      background: var(--header-bg);
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    header h1 {
      font-size: var(--font-size-lg);
      margin-bottom: 8px;
      color: var(--accent);
    }

    header p {
      font-size: var(--font-size-md);
      color: var(--text-dim);
      margin: 4px 0;
    }

    header p a {
      font-weight: bold;
    }

    /* ===================================================
       Tab Navigation Styles (Preserved; + 24-hour tab added in HTML)
       =================================================== */
    .tabs {
      display: flex;
      justify-content: center;
      background: var(--header-bg);
      margin-bottom: 20px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .tabs .tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      cursor: pointer;
      font-size: var(--font-size-md);
      color: var(--text-light);
      transition: background var(--transition);
    }

    .tabs .tab:hover {
      background: var(--panel-bg);
    }

    .tabs .tab.active {
      background: var(--accent);
      color: #ffffff;
    }

    /* ===================================================
       Table Container and Table Styles (Preserved)
       =================================================== */
    .table-container {
      display: none;
      background: var(--panel-bg);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 40px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .table-container.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: auto;
      font-size: var(--font-size-sm);
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--accent-light);
      color: #fff;
      font-weight: normal;
      padding: 12px;
      border-bottom: 2px solid var(--bg-color);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: pointer;
      user-select: none;
    }

    thead th.asc::after {
      content: ' ▲';
    }

    thead th.desc::after {
      content: ' ▼';
    }

    th, td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #444;
    }

    tbody tr:nth-child(odd) {
      background: #3a3a3a;
    }
    tbody tr:nth-child(even) {
      background: #343434;
    }

    td a.profile-link {
      color: var(--accent);
      word-break: break-all;
      font-size: var(--font-size-sm);
    }
    td a.profile-link:hover {
      color: var(--accent-light);
    }

    /* ===================================================
       Responsive Styles for Narrow Viewports (Preserved)
       =================================================== */
    @media (max-width: 900px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 15px;
      }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
      }
      td::before {
        content: attr(data-label);
        flex: 1 1 40%;
        color: var(--text-dim);
        font-weight: bold;
        text-transform: uppercase;
      }
      td span, td a, td div {
        flex: 1 1 60%;
        text-align: right;
      }
    }

    /* ===================================================
       Utility & Helper Classes (Preserved)
       =================================================== */
    .hidden {
      display: none !important;
    }

    .center {
      text-align: center;
    }

    /* ===================================================
       Additional Minor UI Helpers (non-functional, for clarity)
       =================================================== */
    .note {
      color: #e8e8e8;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 10px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #444;
      color: #ddd;
      font-size: 0.75rem;
    }

    /* End of CSS. All original styles preserved and used. */
  </style>
</head>

<body>
  <!-- ===================================================
       Header (Preserved content; Last updated text populated by JS)
       =================================================== -->
  <header>
    <h1>Nitro Type Top 1000 Racers</h1>
    <p>
      made by
      <a href="https://www.youtube.com/@InternetTyper" target="_blank">
        @InternetTyper on YouTube
      </a>
    </p>
    <p id="lastUpdated">Last updated: <span></span></p>
    <p>Contact: azrael.for.god on Discord</p>
  </header>

  <!-- ===================================================
       Tab Navigation (Preserved + Added "24-Hour Changes")
       =================================================== -->
  <div class="tabs">
    <div class="tab active" data-target="leaderboardSection">Leaderboard</div>
    <div class="tab" data-target="racesPerDaySection">Races Per Day</div>
    <div class="tab" data-target="changes24Section">24-Hour Changes</div>
  </div>

  <!-- Optional note explaining data cadence (non-blocking UI text) -->
  <div class="note">
    Data snapshots are intended for 8:00 PM America/Chicago daily. The "Last updated" time comes directly from the JSON snapshot when available.
  </div>

  <!-- ===================================================
       Leaderboard Section (Preserved Columns)
       =================================================== -->
  <section id="leaderboardSection" class="table-container active">
    <table id="leaderboardTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Team Tag</th>
          <th>Title</th>
          <th>Total Races</th>
          <th>Avg WPM</th>
          <th>Top WPM</th>
          <th>Profile Views</th>
          <th>Member Since</th>
          <th>Garage Cars</th>
          <th>Profile URL</th>
          <th>Membership</th>
          <th>Nitros Used</th>
          <th>Longest Session</th>
          <th>League Tier</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript (preserved approach) -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       Races Per Day Section (Preserved Columns)
       =================================================== -->
  <section id="racesPerDaySection" class="table-container">
    <table id="racesPerDayTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Total Races</th>
          <th>Days Active</th>
          <th>Races / Day</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript (preserved approach) -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       24-Hour Changes Section (New; aligns with "other things" on LB)
       - Deltas for numeric stats: races, speeds, views, cars, nitros,
         longest session, and league tier.
       - Excludes non-numeric fields like title, membership, and date.
       =================================================== -->
  <section id="changes24Section" class="table-container">
    <table id="changes24Table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Δ Total Races</th>
          <th>Δ Avg WPM</th>
          <th>Δ Top WPM</th>
          <th>Δ Profile Views</th>
          <th>Δ Garage Cars</th>
          <th>Δ Nitros Used</th>
          <th>Δ Longest Session</th>
          <th>Δ League Tier</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
  </section>

  <!-- ===================================================
       JavaScript
         - PRESERVED: Tab switching logic
         - EXTENDED: Robust data fetch for current & previous snapshots
         - EXTENDED: Real "Last updated" from JSON updatedAt (fallback to now)
         - PRESERVED: Render Leaderboard (with comma formatting)
         - PRESERVED: Render Races Per Day (with comma + 2-decimal formatting)
         - PRESERVED: Enable click-to-sort on every column (with rank renumber)
         - NEW: Render 24-Hour Changes (deltas per stat)
         - PRESERVED STYLE: Keep function structures and comments consistent
     =================================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===================================================
      // Populate last-updated timestamp (now a real value from JSON if present)
      // ===================================================
      /**
       * We will set Last Updated in two phases:
       * 1) Optimistic: show a placeholder while fetching.
       * 2) Actual: after data loads, prefer "updatedAt" from sample_data.json.
       *    If missing or malformed, fall back to Date.now().
       */
      const lastUpdatedSpan = document.querySelector('#lastUpdated span');
      if (lastUpdatedSpan) {
        lastUpdatedSpan.textContent = 'Loading...';
      }

      // ===================================================
      // Tab switching setup (Preserved)
      // ===================================================
      const tabs     = document.querySelectorAll('.tabs .tab');
      const sections = document.querySelectorAll('.table-container');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          sections.forEach(s => s.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.target).classList.add('active');
        });
      });

      // ===================================================
      // Data Fetch & Render Tables
      //   - Now fetches both current and previous snapshots.
      //   - Accepts both legacy array and new object payloads.
      // ===================================================
      /**
       * Expected new shape (preferred):
       * {
       *   "updatedAt": "2025-08-10T20:00:00-05:00",
       *   "racers": [ { ... }, ... ]
       * }
       *
       * Legacy shape (still supported):
       * [ { ... }, ... ]
       */
      Promise.all([
        fetch('sample_data.json').then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status} - ${r.statusText}`);
          return r.json();
        }),
        fetch('sample_data_prev.json')
          .then(r => r.ok ? r.json() : { racers: [] })
          .catch(() => ({ racers: [] }))
      ])
      .then(([curData, prevData]) => {
        // Normalize current data
        const cur = normalizeData(curData);
        // Normalize previous data
        const prev = normalizeData(prevData);

        // Update Last Updated from JSON updatedAt if present, else fallback
        if (lastUpdatedSpan) {
          const dateToShow = cur.updatedAt
            ? new Date(cur.updatedAt)
            : new Date(); // fallback to "now" if no updatedAt
          lastUpdatedSpan.textContent = dateToShow.toLocaleString();
        }

        // Build a quick lookup map for previous snapshot (case-insensitive by username)
        const prevMap = new Map(
          (prev.racers || []).map(r => [String(r.username || '').toLowerCase(), r])
        );

        // Render main tables (Preserved functions + slight enhancement: clickable usernames)
        renderLeaderboard(cur.racers);
        renderRacesPerDay(cur.racers);

        // Render 24-hour changes (new)
        renderChanges24(cur.racers, prevMap);

        // Enable sorting on all tables (Preserved behavior)
        enableSorting('leaderboardTable');
        enableSorting('racesPerDayTable');
        enableSorting('changes24Table');
      })
      .catch(err => {
        console.error('Failed to load data:', err);
        if (lastUpdatedSpan) {
          lastUpdatedSpan.textContent = new Date().toLocaleString();
        }
        const msg = document.createElement('p');
        msg.textContent = 'Error loading sample_data.json – check console.';
        msg.style.color = '#ff5252';
        msg.style.textAlign = 'center';
        document.body.appendChild(msg);
      });

      /**
       * Normalize data payloads so downstream logic can rely on a consistent shape.
       * Accepts array (legacy) or object { updatedAt, racers } (preferred).
       */
      function normalizeData(payload) {
        if (Array.isArray(payload)) {
          // Legacy mode: no updatedAt; racers = payload
          return {
            updatedAt: null,
            racers: payload
          };
        }
        if (payload && Array.isArray(payload.racers)) {
          // Preferred mode
          return {
            updatedAt: payload.updatedAt || null,
            racers: payload.racers
          };
        }
        // Fallback empty
        return {
          updatedAt: null,
          racers: []
        };
      }

      // ===================================================
      // Renders the main leaderboard table. (Preserved)
      // - Sorts by total races descending initially.
      // - Formats all numeric cells with commas.
      // - Enhancements:
      //   - Username is now clickable to profileURL, as requested.
      // ===================================================
      function renderLeaderboard(data) {
        // Defensive copy so sorting doesn't mutate the original array unexpectedly
        const sorted = [...data].sort((a, b) => b.racesPlayed - a.racesPlayed);
        const tbody = document.querySelector('#leaderboardTable tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        sorted.forEach((r, idx) => {
          const tr = document.createElement('tr');

          // Format numbers with commas via toLocaleString()
          // (Preserved from your original approach)
          const totalRaces   = safeNumber(r.racesPlayed).toLocaleString();
          const avgWPM       = safeNumber(r.avgSpeed).toLocaleString();
          const topWPM       = safeNumber(r.highestSpeed).toLocaleString();
          const profileViews = safeNumber(r.profileViews).toLocaleString();
          const garageCars   = safeNumber(r.garageCars).toLocaleString();
          const nitrosUsed   = safeNumber(r.nitrosUsed).toLocaleString();
          const longestSess  = safeNumber(r.longestSession).toLocaleString();
          const leagueTier   = safeNumber(r.leagueTier).toLocaleString();

          const username = r.username || '';
          const teamTag  = r.tag || '';
          const title    = r.title || '';
          const joinDate = r.joinDate || '';
          const membership = r.membership || '';
          const profileURL = r.profileURL || '#';

          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username">
              <a href="${escapeAttr(profileURL)}" target="_blank">${escapeHTML(username)}</a>
            </td>
            <td data-label="Team Tag">${escapeHTML(teamTag)}</td>
            <td data-label="Title">${escapeHTML(title)}</td>
            <td data-label="Total Races">${totalRaces}</td>
            <td data-label="Avg WPM">${avgWPM}</td>
            <td data-label="Top WPM">${topWPM}</td>
            <td data-label="Profile Views">${profileViews}</td>
            <td data-label="Member Since">${escapeHTML(joinDate)}</td>
            <td data-label="Garage Cars">${garageCars}</td>
            <td data-label="Profile URL">
              <a class="profile-link" href="${escapeAttr(profileURL)}" target="_blank">
                View Profile
              </a>
            </td>
            <td data-label="Membership">${escapeHTML(membership)}</td>
            <td data-label="Nitros Used">${nitrosUsed}</td>
            <td data-label="Longest Session">${longestSess}</td>
            <td data-label="League Tier">${leagueTier}</td>
          `.trim();

          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Renders the Races Per Day table. (Preserved)
      // - Calculates daysActive & racesPerDay, sorts descending initially.
      // - Formats integers with commas and per-day with commas + 2 decimals.
      // - Enhancements:
      //   - Username is clickable to profileURL.
      // ===================================================
      function renderRacesPerDay(data) {
        const list = data.map(r => {
          // Use date only for consistency across timezones
          const joinDate = parseLocalDate(r.joinDate);
          const now = new Date();
          let diffMs = now - joinDate;
          let daysActive = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          if (!Number.isFinite(daysActive) || daysActive < 1) daysActive = 1;

          const perDayRaw = safeNumber(r.racesPlayed) / daysActive;
          const perDayFmt = perDayRaw.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });

          return {
            username:    r.username || '',
            profileURL:  r.profileURL || '#',
            racesPlayed: safeNumber(r.racesPlayed),
            daysActive:  daysActive,
            racesPerDay: perDayRaw,
            formattedRacesPlayed: safeNumber(r.racesPlayed).toLocaleString(),
            formattedDaysActive:  daysActive.toLocaleString(),
            formattedPerDay:      perDayFmt
          };
        });

        // Sort by raw racesPerDay descending
        list.sort((a, b) => b.racesPerDay - a.racesPerDay);

        const tbody = document.querySelector('#racesPerDayTable tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        list.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username">
              <a href="${escapeAttr(r.profileURL)}" target="_blank">${escapeHTML(r.username)}</a>
            </td>
            <td data-label="Total Races">${r.formattedRacesPlayed}</td>
            <td data-label="Days Active">${r.formattedDaysActive}</td>
            <td data-label="Races / Day">${r.formattedPerDay}</td>
          `.trim();
          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Renders the 24-Hour Changes table. (New)
      // - Computes diffs vs. previous snapshot for key numeric stats.
      // - Sorts by Δ Total Races descending initially.
      // - Username is clickable to profile URL.
      // ===================================================
      function renderChanges24(currentRacers, prevMap) {
        // Prepare diffs list with robust defaulting
        const diffs = currentRacers.map(r => {
          const key = String(r.username || '').toLowerCase();
          const p = prevMap.get(key) || {};

          // Each delta is current - previous, fallback previous to 0 if missing
          const dRaces = safeNumber(r.racesPlayed) - safeNumber(p.racesPlayed);
          const dAvg   = safeNumber(r.avgSpeed)    - safeNumber(p.avgSpeed);
          const dTop   = safeNumber(r.highestSpeed)- safeNumber(p.highestSpeed);
          const dViews = safeNumber(r.profileViews)- safeNumber(p.profileViews);
          const dCars  = safeNumber(r.garageCars)  - safeNumber(p.garageCars);
          const dNitro = safeNumber(r.nitrosUsed)  - safeNumber(p.nitrosUsed);
          const dSess  = safeNumber(r.longestSession) - safeNumber(p.longestSession);
          const dTier  = safeNumber(r.leagueTier)  - safeNumber(p.leagueTier);

          return {
            username:   r.username || '',
            profileURL: r.profileURL || '#',
            dRaces,
            dAvg,
            dTop,
            dViews,
            dCars,
            dNitro,
            dSess,
            dTier
          };
        });

        // Sort by Δ Total Races desc as a useful default
        diffs.sort((a, b) => b.dRaces - a.dRaces);

        // Render
        const tbody = document.querySelector('#changes24Table tbody');
        tbody.innerHTML = '';
        const fragment = document.createDocumentFragment();

        diffs.forEach((d, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${idx + 1}</td>
            <td data-label="Username">
              <a href="${escapeAttr(d.profileURL)}" target="_blank">${escapeHTML(d.username)}</a>
            </td>
            <td data-label="Δ Total Races">${formatDeltaInt(d.dRaces)}</td>
            <td data-label="Δ Avg WPM">${formatDeltaFloat(d.dAvg, 2)}</td>
            <td data-label="Δ Top WPM">${formatDeltaInt(d.dTop)}</td>
            <td data-label="Δ Profile Views">${formatDeltaInt(d.dViews)}</td>
            <td data-label="Δ Garage Cars">${formatDeltaInt(d.dCars)}</td>
            <td data-label="Δ Nitros Used">${formatDeltaInt(d.dNitro)}</td>
            <td data-label="Δ Longest Session">${formatDeltaInt(d.dSess)}</td>
            <td data-label="Δ League Tier">${formatDeltaInt(d.dTier)}</td>
          `.trim();
          fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);
      }

      // ===================================================
      // Sorting: Attaches click handlers to each <th> in a given table,
      // toggles asc/desc classes, re-sorts rows, AND renumbers Rank.
      // (Preserved from your original approach with numeric parsing)
      // ===================================================
      function enableSorting(tableId) {
        const table   = document.getElementById(tableId);
        if (!table) return;
        const headers = table.querySelectorAll('th');

        headers.forEach((th, idx) => {
          th.addEventListener('click', () => {
            const tbody = table.querySelector('tbody');
            const rows  = Array.from(tbody.querySelectorAll('tr'));
            const asc   = !th.classList.contains('asc');

            // Perform sort; strip commas and non-numeric chars for numeric compare
            rows.sort((a, b) => {
              const aText = a.children[idx]?.textContent?.trim() ?? '';
              const bText = b.children[idx]?.textContent?.trim() ?? '';
              const aNum  = parseFloat(aText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
              const bNum  = parseFloat(bText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));

              if (!isNaN(aNum) && !isNaN(bNum)) {
                return asc ? aNum - bNum : bNum - aNum;
              }
              return asc
                ? aText.localeCompare(bText)
                : bText.localeCompare(aText);
            });

            // Reset and set sort indicators
            headers.forEach(h => h.classList.remove('asc','desc'));
            th.classList.add(asc ? 'asc' : 'desc');

            // Renumber the Rank column based on new order
            rows.forEach((row, newIndex) => {
              if (row.children[0]) {
                row.children[0].textContent = newIndex + 1;
              }
            });

            // Re-attach sorted rows
            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));
          });
        });
      }

      // ===================================================
      // Helper Utilities (Safe formatting, escaping, dates)
      // ===================================================

      /**
       * Returns a finite number. If input is null/undefined/NaN, returns 0.
       */
      function safeNumber(x) {
        const n = Number(x);
        return Number.isFinite(n) ? n : 0;
        }

      /**
       * Format integer deltas with sign and commas
       * e.g., +1,234 or -56 or 0
       */
      function formatDeltaInt(n) {
        const v = safeNumber(n);
        const sign = v > 0 ? '+' : v < 0 ? '' : '';
        return `${sign}${v.toLocaleString()}`;
      }

      /**
       * Format float deltas with sign and fixed decimals.
       * e.g., +1.23 or -0.50 or 0.00
       */
      function formatDeltaFloat(n, digits = 2) {
        const v = Number.isFinite(n) ? n : 0;
        const sign = v > 0 ? '+' : v < 0 ? '' : '';
        return `${sign}${v.toLocaleString(undefined, {
          minimumFractionDigits: digits,
          maximumFractionDigits: digits
        })}`;
      }

      /**
       * Escape text for safe HTML text insertion.
       */
      function escapeHTML(s) {
        return String(s ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      /**
       * Escape attribute values.
       */
      function escapeAttr(s) {
        return escapeHTML(s).replace(/"/g, '&quot;');
      }

      /**
       * Parse a date string as local date (YYYY-MM-DD or other),
       * falling back to today if invalid. We append T00:00:00 to
       * avoid timezone midnight drift issues when converting.
       */
      function parseLocalDate(input) {
        const raw = String(input || '').trim();
        // Attempt to keep original semantics; if joinDate looks like YYYY-MM-DD, coerce as local date
        if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
          const [y, m, d] = raw.split('-').map(n => parseInt(n, 10));
          // Months are 0-indexed in Date
          const dt = new Date(y, (m - 1), d, 0, 0, 0, 0);
          if (!isNaN(dt.getTime())) return dt;
        }
        // Fallback generic Date parse
        const dt2 = new Date(raw);
        if (!isNaN(dt2.getTime())) return dt2;
        // Fallback to "today"
        return new Date();
      }

    // End of DOMContentLoaded
  });
</script>

<-- Load removeGlitchedRacers.js after DOM is ready -->
<script src="scripts/removeGlitchedRacers.js"></script>

</body>
</html>
