<!DOCTYPE html>
<html lang="en">
<head>
    :root {
      /* Dark palette */
      --bg: #0f1217;
      --surface: #151925;
      --surface-2: #1a2131;
      --surface-3: #202a3f;
      --text: #e9eef6;
      --text-dim: #b8c3d6;
      --muted: #8da0be;
      --accent: #6ea8fe;
      --accent-2: #8fdaff;
      --good: #37d67a;
      --warn: #ffb020;
      --bad: #ff5c5c;
      --border: #2a3246;
      --shadow: rgba(0,0,0,0.35);
      --focus: #82b1ff;

      /* Layout */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;

      --pad-1: 0.4rem;
      --pad-2: 0.66rem;
      --pad-3: 1rem;

      /* Expanded frame + wide tables */
      --page-max: 1900px;   /* widen the “frame” to show more columns */
      --table-min: 1650px;  /* minimum table width before horizontal scrolling */

      /* Fonts */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* Scroll hint */
      --scroll-hint-width: 42px;
      --scroll-hint-fade: linear-gradient(90deg, rgba(21,25,37,0), rgba(21,25,37,0.9) 65%, rgba(21,25,37,1));
    }

    /* Optional light-mode palette via prefers-color-scheme */
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f4f7fb;
        --surface: #ffffff;
        --surface-2: #f4f6fb;
        --surface-3: #e9eef7;
        --text: #0d1625;
        --text-dim: #38465f;
        --muted: #5b6b86;
        --accent: #3b82f6;
        --accent-2: #0ea5e9;
        --good: #16a34a;
        --warn: #d97706;
        --bad: #dc2626;
        --border: #d9e1ee;
        --shadow: rgba(0,0,0,0.12);
        --focus: #3b82f6;
      }
    }

    /* Base */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(1100px 700px at 15% -10%, #172241 0%, var(--bg) 65%) no-repeat fixed;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: var(--pad-3);
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { color: var(--accent-2); }

    /* Expanded frame */
    header, .tabs, .table-container {
      width: min(100%, var(--page-max));
      margin-inline: auto;
    }

    /* Header */
    header {
      text-align: center;
      padding: 16px 12px;
      margin: 0 auto var(--pad-3);
      background: linear-gradient(180deg, rgba(32,42,63,0.78), rgba(26,33,49,0.78));
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: 0 10px 24px var(--shadow);
    }
    header h1 {
      margin: 0 0 6px;
      font-weight: 900;
      letter-spacing: 0.3px;
      color: #f6f9ff;
      text-shadow: 0 6px 18px rgba(110,168,254,0.2);
    }
    header p { margin: 4px 0; color: var(--text-dim); }

    /* Tabs */
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--pad-2);
      align-items: stretch;
      margin: 0 auto var(--pad-3);
    }
    .tabs .tab {
      background: linear-gradient(180deg, var(--surface-3), var(--surface-2));
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.66rem 0.8rem;
      text-align: center;
      font-weight: 800;
      letter-spacing: 0.2px;
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      transition: transform .05s ease, box-shadow .18s ease, border-color .18s ease, color .18s ease;
      box-shadow: 0 2px 0 var(--shadow) inset, 0 0 0 rgba(0,0,0,0);
    }
    .tabs .tab:hover {
      transform: translateY(-1px);
      box-shadow: 0 7px 18px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.03) inset;
    }
    .tabs .tab.active {
      color: #ffffff;
      border-color: var(--focus);
      text-shadow: 0 0 10px rgba(110,168,254,0.6);
    }

    /* Sections / table container with horizontal scroll */
    .table-container {
      display: block;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 10px;
      margin: 0 auto 40px;
      overflow-x: auto; /* key: allow horizontal scroll to show all columns */
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 18px 40px var(--shadow);
      position: relative;
    }
    .table-container.active { display: block; }
    .hidden { display: none !important; }

    .note {
      color: #e8ecf1;
      font-size: 0.95rem;
      text-align: center;
      margin: 8px 0 12px;
    }

    /* Optional scroll hint overlay */
    .table-container.has-scroll-hint::after {
      content: '';
      position: sticky;
      right: 0;
      top: 0;
      width: var(--scroll-hint-width);
      height: 100%;
      pointer-events: none;
      background: var(--scroll-hint-fade);
      z-index: 3;
    }
    .table-container.has-scroll-hint.is-end::after { opacity: 0; transition: opacity .25s ease; }
    .table-container.has-scroll-hint:not(.is-end)::after { opacity: 1; transition: opacity .25s ease; }

    /* Tables */
    table {
      width: 100%;
      min-width: var(--table-min); /* key: ensure columns have space; container scrolls if needed */
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 0.92rem;
    }

    /* Column sizing hints for Main Leaderboard (16 columns) */
    #leaderboardTable th:nth-child(1),  #leaderboardTable td:nth-child(1)  { min-width: 70px; }   /* Rank */
    #leaderboardTable th:nth-child(2),  #leaderboardTable td:nth-child(2)  { min-width: 220px; }  /* Display Name */
    #leaderboardTable th:nth-child(3),  #leaderboardTable td:nth-child(3)  { min-width: 160px; }  /* Username */
    #leaderboardTable th:nth-child(4),  #leaderboardTable td:nth-child(4)  { min-width: 120px; }  /* Team Tag */
    #leaderboardTable th:nth-child(5),  #leaderboardTable td:nth-child(5)  { min-width: 220px; }  /* Title */
    #leaderboardTable th:nth-child(6),  #leaderboardTable td:nth-child(6)  { min-width: 140px; }  /* Total Races */
    #leaderboardTable th:nth-child(7),  #leaderboardTable td:nth-child(7)  { min-width: 120px; }  /* Avg WPM */
    #leaderboardTable th:nth-child(8),  #leaderboardTable td:nth-child(8)  { min-width: 120px; }  /* Top WPM */
    #leaderboardTable th:nth-child(9),  #leaderboardTable td:nth-child(9)  { min-width: 150px; }  /* Profile Views */
    #leaderboardTable th:nth-child(10), #leaderboardTable td:nth-child(10) { min-width: 150px; }  /* Member Since */
    #leaderboardTable th:nth-child(11), #leaderboardTable td:nth-child(11) { min-width: 130px; }  /* Garage Cars */
    #leaderboardTable th:nth-child(12), #leaderboardTable td:nth-child(12) { min-width: 140px; }  /* Membership */
    #leaderboardTable th:nth-child(13), #leaderboardTable td:nth-child(13) { min-width: 160px; }  /* Profile URL */
    #leaderboardTable th:nth-child(14), #leaderboardTable td:nth-child(14) { min-width: 140px; }  /* Nitros Used */
    #leaderboardTable th:nth-child(15), #leaderboardTable td:nth-child(15) { min-width: 160px; }  /* Longest Session */
    #leaderboardTable th:nth-child(16), #leaderboardTable td:nth-child(16) { min-width: 130px; }  /* League Tier */

    /* 24-Hour table (6 columns) */
    #changes24Table th:nth-child(1), #changes24Table td:nth-child(1) { min-width: 70px; }    /* Rank */
    #changes24Table th:nth-child(2), #changes24Table td:nth-child(2) { min-width: 240px; }   /* Display Name */
    #changes24Table th:nth-child(3), #changes24Table td:nth-child(3) { min-width: 160px; }   /* Δ Total Races */
    #changes24Table th:nth-child(4), #changes24Table td:nth-child(4) { min-width: 140px; }   /* Δ Top WPM */
    #changes24Table th:nth-child(5), #changes24Table td:nth-child(5) { min-width: 170px; }   /* Δ Profile Views */
    #changes24Table th:nth-child(6), #changes24Table td:nth-child(6) { min-width: 160px; }   /* Δ Nitros Used */

    /* Races Per Day table (6 columns: Member Since added) */
    #racesPerDayTable th:nth-child(1), #racesPerDayTable td:nth-child(1) { min-width: 70px; }   /* Rank */
    #racesPerDayTable th:nth-child(2), #racesPerDayTable td:nth-child(2) { min-width: 240px; }  /* Display Name */
    #racesPerDayTable th:nth-child(3), #racesPerDayTable td:nth-child(3) { min-width: 150px; }  /* Total Races */
    #racesPerDayTable th:nth-child(4), #racesPerDayTable td:nth-child(4) { min-width: 140px; }  /* Days Active */
    #racesPerDayTable th:nth-child(5), #racesPerDayTable td:nth-child(5) { min-width: 150px; }  /* Races / Day */
    #racesPerDayTable th:nth-child(6), #racesPerDayTable td:nth-child(6) { min-width: 160px; }  /* Member Since */

    /* Event table (7 columns) */
    #eventTable th:nth-child(1), #eventTable td:nth-child(1) { min-width: 70px; }    /* Rank */
    #eventTable th:nth-child(2), #eventTable td:nth-child(2) { min-width: 220px; }   /* Display Name */
    #eventTable th:nth-child(3), #eventTable td:nth-child(3) { min-width: 150px; }   /* Total Races (Δ) */
    #eventTable th:nth-child(4), #eventTable td:nth-child(4) { min-width: 130px; }   /* Avg WPM */
    #eventTable th:nth-child(5), #eventTable td:nth-child(5) { min-width: 150px; }   /* Avg Accuracy */
    #eventTable th:nth-child(6), #eventTable td:nth-child(6) { min-width: 160px; }   /* Profile Views (Δ) */
    #eventTable th:nth-child(7), #eventTable td:nth-child(7) { min-width: 150px; }   /* Nitros Used (Δ) */

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(180deg, var(--surface-3), var(--surface-2));
      color: var(--text);
      font-weight: 800;
      letter-spacing: 0.15px;
      padding: 0.6rem 0.66rem;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      text-align: right;
    }
    thead th:first-child,
    thead th:nth-child(2),
    thead th:nth-child(3) { text-align: left; }

    thead th.asc,
    thead th.desc {
      color: #ffffff;
      text-shadow: 0 0 10px rgba(110,168,254,0.6);
    }
    thead th.asc::after,
    thead th.desc::after {
      content: '';
      display: inline-block;
      margin-left: 6px;
      width: 0;
      height: 0;
      vertical-align: middle;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
    }
    thead th.asc::after { border-bottom: 7px solid var(--accent); }
    thead th.desc::after { border-top: 7px solid var(--accent); }

    tbody td {
      padding: 0.56rem 0.66rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      color: var(--text);
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    tbody td:first-child,
    tbody td:nth-child(2),
    tbody td:nth-child(3) { text-align: left; }

    tbody tr:nth-child(even) { background: rgba(255,255,255,0.025); }
    tbody tr:hover { background: linear-gradient(90deg, rgba(110,168,254,0.08), rgba(110,168,254,0)); }

    /* Link utility: white underline for key links */
    a.link-quiet, a.link-quiet:visited {
      color: #fff;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,0.9);
      text-underline-offset: 2px;
    }
    a.link-quiet:hover { text-decoration-color: #fff; }

    a.tag-link, a.tag-link:visited {
      color: #fff;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    a.tag-link:hover { text-decoration-color: #fff; }

    /* Optional: sticky first column (add class "sticky-first-col" on a table) */
    table.sticky-first-col th:first-child,
    table.sticky-first-col td:first-child {
      position: sticky;
      left: 0;
      z-index: 3;
      background: linear-gradient(180deg, var(--surface-3), var(--surface-2));
      box-shadow: 3px 0 0 rgba(0,0,0,0.08);
    }

    /* Responsive tuning */
    @media (min-width: 1500px) {
      table { font-size: 0.95rem; }
      thead th, tbody td { padding: 0.66rem 0.75rem; }
    }
    @media (max-width: 1200px) {
      :root { --table-min: 1500px; } /* slight shrink */
    }

    /* Stacked-card mode (optional): add class "stack-on-mobile" to .table-container to enable */
    @media (max-width: 950px) {
      .table-container.stack-on-mobile table,
      .table-container.stack-on-mobile thead,
      .table-container.stack-on-mobile tbody,
      .table-container.stack-on-mobile th,
      .table-container.stack-on-mobile td,
      .table-container.stack-on-mobile tr { display: block; }

      .table-container.stack-on-mobile thead { display: none; }
      .table-container.stack-on-mobile tr { margin-bottom: 15px; }

      .table-container.stack-on-mobile td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
      }
      .table-container.stack-on-mobile td::before {
        content: attr(data-label);
        flex: 1 1 42%;
        color: var(--text-dim);
        font-weight: 800;
        text-transform: uppercase;
        padding-right: 12px;
      }
      .table-container.stack-on-mobile td span,
      .table-container.stack-on-mobile td a,
      .table-container.stack-on-mobile td div {
        flex: 1 1 58%;
        text-align: right;
      }
    }

    /* A11y + motion */
    :focus-visible {
      outline: 3px solid rgba(130,177,255,0.35);
      outline-offset: 2px;
      border-radius: 8px;
    }
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }

    /* Scrollbar styling */
    .table-container { scrollbar-width: thin; scrollbar-color: #3a4560 var(--surface); }
    .table-container::-webkit-scrollbar { height: 12px; width: 12px; }
    .table-container::-webkit-scrollbar-track { background: var(--surface); }
    .table-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #3a4560, #2b344a);
      border-radius: 10px;
      border: 2px solid var(--surface);
    }
    .table-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #4b5a7c, #37415a);
    }

    /* High-contrast mode */
    @media (forced-colors: active) {
      :root {
        --bg: Canvas;
        --surface: Canvas;
        --surface-2: Canvas;
        --surface-3: Canvas;
        --text: CanvasText;
        --text-dim: CanvasText;
        --border: GrayText;
        --accent: LinkText;
        --accent-2: LinkText;
      }
      header, .tabs .tab, .table-container, thead th, tbody td {
        forced-color-adjust: none;
        border-color: var(--border);
        color: var(--text);
        background: var(--surface);
      }
      a, a:hover { color: var(--accent); }
    }

    /* Print */
    @media print {
      body { background: #fff; color: #000; padding: 0; }
      header, .tabs, .note { display: none !important; }
      .table-container {
        box-shadow: none;
        border: 1px solid #000;
        overflow: visible;
      }
      thead th {
        position: static;
        background: #f2f2f2;
        color: #000;
        text-shadow: none;
      }
      table {
        min-width: auto;
        font-size: 10pt;
      }
      a { color: #000; text-decoration: underline; }
    }

    /* Utilities */
    .nowrap { white-space: nowrap; }
    .truncate { max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .num { font-variant-numeric: tabular-nums; }
    .center { text-align: center !important; }
    .left { text-align: left !important; }
    .right { text-align: right !important; }
    .mono { font-family: var(--mono); }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>Nitro Type Top 1000 & Event Leaderboard</h1>
    <p>
      made by
      <a href="https://www.youtube.com/@InternetTyper" target="_blank" rel="noopener noreferrer">
        @InternetTyper on YouTube
      </a>
    </p>
    <p id="lastUpdated">Last updated: <span>—</span></p>
    <p>Contact: https://discord.gg/3XVdxvKgAt on Discord</p>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-target="leaderboardSection">Leaderboard</div>
    <div class="tab" data-target="racesPerDaySection">Races Per Day</div>
    <div class="tab" data-target="changes24Section">24-Hour Leaderboard</div>
    <div class="tab" data-target="eventSection">Event</div>
  </div>

  <!-- Main Leaderboard (Everything) -->
  <section id="leaderboardSection" class="table-container active has-scroll-hint">
    <table id="leaderboardTable" class="sticky-first-col">
      <thead>
        <tr>
          <th class="desc">Rank</th>
          <th>Display Name</th>
          <th>Username</th>
          <th>Team Tag</th>
          <th>Title</th>
          <th>Total Races</th>
          <th>Avg WPM</th>
          <th>Top WPM</th>
          <th>Profile Views</th>
          <th>Member Since</th>
          <th>Garage Cars</th>
          <th>Membership</th>
          <th>Profile URL</th>
          <th>Nitros Used</th>
          <th>Longest Session</th>
          <th>League Tier</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
    <p class="note" id="leaderboardNote"></p>
  </section>

  <!-- Races Per Day (with Join Date) -->
  <section id="racesPerDaySection" class="table-container has-scroll-hint">
    <table id="racesPerDayTable">
      <thead>
        <tr>
          <th class="desc">Rank</th>
          <th>Display Name</th>
          <th>Total Races</th>
          <th>Days Active</th>
          <th>Races / Day</th>
          <th>Member Since</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
    <p class="note" id="rpdNote"></p>
  </section>

  <!-- 24-Hour Leaderboard (only four metrics) -->
  <section id="changes24Section" class="table-container has-scroll-hint">
    <table id="changes24Table">
      <thead>
        <tr>
          <th class="desc">Rank</th>
          <th>Display Name</th>
          <th>Δ Total Races</th>
          <th>Δ Top WPM</th>
          <th>Δ Profile Views</th>
          <th>Δ Nitros Used</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
    <p class="note" id="dailyNote"></p>
  </section>

  <!-- Event Leaderboard (period-based metrics) -->
  <section id="eventSection" class="table-container has-scroll-hint">
    <div class="note" id="eventInfo">
      Event combines API_before/now and Before/After Data. Totals shown here are period deltas (Δ).
    </div>
    <div id="eventComingSoon" class="note hidden">Coming Soon</div>
    <table id="eventTable">
      <thead>
        <tr>
          <th class="desc">Rank</th>
          <th>Display Name</th>
          <th>Total Races</th>
          <th>Avg WPM</th>
          <th>Avg Accuracy</th>
          <th>Profile Views</th>
          <th>Nitros Used</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows injected by JavaScript -->
      </tbody>
    </table>
    <p class="note" id="eventStatus"></p>
  </section>

  <!-- Full JavaScript -->
  <script>
    (function () {
      'use strict';

      // =====================================================================================
      // CONFIGURATION
      // =====================================================================================
      const MAX_24H_RACES = 2600; // Filter out anomalies in 24-hour diffs

      const DATA_FILES = {
        current: 'sample_data.json',       // today's snapshot
        previous: 'sample_data_prev.json'  // yesterday's snapshot
      };

      const EVENT_FILES = {
        apiBefore: 'API_before.json',
        apiNow: 'API_now.json',
        dataBefore: 'BeforeEventData.json',
        dataNow: 'AfterEventData.json'
      };

      // Use API_now to enrich display names (actual displayName) and optionally team tag
      const ENRICH_FROM_API_NOW = true;

      // Event "Avg WPM" method:
      //   'weighted' = (avgNow*playedNow - avgBefore*playedBefore) / Δplayed
      //   'current'  = fallback to API_now avgWpm if weighted is not possible
      const WPM_METHOD = 'weighted';

      // =====================================================================================
      // DOM REFERENCES
      // =====================================================================================
      const tabs = document.querySelectorAll('.tabs .tab');
      const sections = document.querySelectorAll('.table-container');

      const lastUpdatedSpan = document.querySelector('#lastUpdated span');
      const lastUpdatedEl = lastUpdatedSpan || document.getElementById('lastUpdated');

      // Add scroll hint fading if scrolled to far-right
      sections.forEach(container => {
        container.addEventListener('scroll', () => {
          const atEnd = Math.ceil(container.scrollLeft + container.clientWidth) >= container.scrollWidth;
          if (atEnd) container.classList.add('is-end');
          else container.classList.remove('is-end');
        });
      });

      // =====================================================================================
      // TABS
      // =====================================================================================
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          sections.forEach(s => s.classList.remove('active'));
          tab.classList.add('active');
          const target = document.getElementById(tab.dataset.target);
          if (target) target.classList.add('active');
        });
      });

      // =====================================================================================
      // BOOTSTRAP: Load current/previous Data, enrich with API_now, render main views, then event
      // =====================================================================================
      Promise.all([
        fetchJSONFlexible(DATA_FILES.current),
        fetchJSONFlexible(DATA_FILES.previous, true), // allow empty/missing
        ENRICH_FROM_API_NOW ? fetchJSONFlexible(EVENT_FILES.apiNow, true) : { racers: [] }
      ])
      .then(([curRaw, prevRaw, apiNowMaybe]) => {
        const current = normalizeData(curRaw);
        const previous = normalizeData(prevRaw);
        const apiNowArr = toArray(apiNowMaybe);

        // Last updated display
        if (lastUpdatedEl) {
          const ts = current.updatedAt ? new Date(current.updatedAt) : new Date();
          if (lastUpdatedSpan) {
            lastUpdatedSpan.textContent = ts.toLocaleString();
          } else {
            lastUpdatedEl.textContent = `Last updated: ${ts.toLocaleString()}`;
          }
        }

        // Build enrichment maps: username(lowercased) -> values
        const displayNameMap = buildDisplayNameMap(apiNowArr); // true display names from API_now
        const teamTagMap = buildTeamTagMap(apiNowArr);         // optional fallback team tag

        // Build prev map for diffs
        const prevMap = new Map((previous.racers || [])
          .map(r => [String(r.username || '').toLowerCase(), r]));

        // Render 3 primary views
        renderLeaderboard(current.racers, displayNameMap, teamTagMap);
        enableSorting('leaderboardTable');

        renderRacesPerDay(current.racers, displayNameMap);
        enableSorting('racesPerDayTable');

        renderChanges24(current.racers, prevMap, displayNameMap);
        enableSorting('changes24Table');

        // Initialize event after core views load
        initEventTab();
      })
      .catch(err => {
        console.error('Error loading data:', err);
        if (lastUpdatedEl) {
          const ts = new Date().toLocaleString();
          if (lastUpdatedSpan) lastUpdatedSpan.textContent = ts;
          else lastUpdatedEl.textContent = `Last updated: ${ts}`;
        }
        const msg = document.createElement('p');
        msg.textContent = 'Error loading data – check console.';
        msg.style.color = '#ff5252';
        msg.style.textAlign = 'center';
        document.body.appendChild(msg);

        // Attempt Event initialization anyway
        initEventTab();
      });

      // =====================================================================================
      // FETCH HELPERS (JSON array/object or NDJSON)
      // =====================================================================================
      async function fetchJSONFlexible(url, allowEmpty = false) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) {
            if (allowEmpty && (res.status === 404 || res.status === 204)) return { racers: [] };
            throw new Error(`${url}: HTTP ${res.status} ${res.statusText}`);
          }
          const text = await res.text();
          const trimmed = text.trim();
          if (!trimmed) return allowEmpty ? { racers: [] } : JSON.parse(''); // force catch path

          const firstChar = trimmed[0];
          if (firstChar === '{' || firstChar === '[') {
            return JSON.parse(trimmed);
          }

          // NDJSON fallback
          const arr = [];
          trimmed.split(/\r?\n/).forEach(line => {
            const l = line.trim();
            if (!l) return;
            try { arr.push(JSON.parse(l)); } catch { /* skip malformed line */ }
          });
          return arr;
        } catch (e) {
          if (allowEmpty) return { racers: [] };
          throw e;
        }
      }

      // =====================================================================================
      // NORMALIZATION + MAPS
      // =====================================================================================
      function normalizeData(payload) {
        if (Array.isArray(payload)) return { updatedAt: null, racers: payload };
        if (payload && Array.isArray(payload.racers)) return { updatedAt: payload.updatedAt || null, racers: payload.racers };
        return { updatedAt: null, racers: [] };
      }

      function toArray(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.racers)) return payload.racers;
        return [];
      }

      function buildDisplayNameMap(apiNowArray) {
        const map = new Map();
        for (const r of apiNowArray || []) {
          const u = String(r.username || '').toLowerCase();
          const dn = String(r.displayName || '').trim();
          if (u && dn) map.set(u, dn);
        }
        return map;
      }

      function buildTeamTagMap(apiNowArray) {
        const map = new Map();
        for (const r of apiNowArray || []) {
          const u = String(r.username || '').toLowerCase();
          const tg = String(r.teamTag || '').trim();
          if (u && tg) map.set(u, tg);
        }
        return map;
      }

      function indexByKey(arr, keyFn) {
        const out = Object.create(null);
        for (const item of arr || []) {
          const k = String(keyFn(item) || '').toLowerCase();
          if (k) out[k] = item;
        }
        return out;
      }

      function pickFirstNonEmpty(arr, fallback) {
        for (const v of arr) {
          if (v !== undefined && v !== null && String(v).trim() !== '') return String(v);
        }
        return fallback;
      }

      // =====================================================================================
      // UTILS
      // =====================================================================================
      function safeNumber(x) {
        const n = Number(x);
        return Number.isFinite(n) ? n : 0;
      }

      function clamp(min, v, max) {
        return Math.max(min, Math.min(max, v));
      }

      function parseLocalDate(input) {
        const raw = String(input || '').trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
          const [y, m, d] = raw.split('-').map(n => parseInt(n, 10));
          const dt = new Date(y, m - 1, d, 0, 0, 0, 0);
          if (!isNaN(dt.getTime())) return dt;
        }
        const dt2 = new Date(raw);
        if (!isNaN(dt2.getTime())) return dt2;
        return new Date();
      }

      function escapeHTML(s) {
        return String(s ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function escapeAttr(s) {
        return escapeHTML(s).replace(/"/g, '&quot;');
      }

      function formatDeltaInt(n) {
        const v = safeNumber(n);
        const sign = v > 0 ? '+' : '';
        return `${sign}${v.toLocaleString()}`;
      }

      function formatPercent(v, min = 2, max = 2) {
        return `${safeNumber(v).toLocaleString(undefined, { minimumFractionDigits: min, maximumFractionDigits: max })}%`;
      }

      function formatFixed(v, min = 0, max = 2) {
        return safeNumber(v).toLocaleString(undefined, { minimumFractionDigits: min, maximumFractionDigits: max });
      }

      function ntRacerURL(username) {
        const slug = String(username || '').trim();
        return slug ? `https://www.nitrotype.com/racer/${encodeURIComponent(slug)}` : '#';
      }

      function ntTeamURL(tag) {
        const t = String(tag || '').trim();
        return t ? `https://www.nitrotype.com/team/${encodeURIComponent(t)}` : '#';
      }

      // =====================================================================================
      // SORTING (numeric-aware + rank renumbering)
      // =====================================================================================
      function enableSorting(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const headers = table.querySelectorAll('th');
        headers.forEach((th, idx) => {
          th.addEventListener('click', () => {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const asc = !th.classList.contains('asc');

            rows.sort((a, b) => {
              const aText = (a.children[idx]?.textContent || '').trim();
              const bText = (b.children[idx]?.textContent || '').trim();
              const aNum = parseFloat(aText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
              const bNum = parseFloat(bText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
              if (!isNaN(aNum) && !isNaN(bNum)) return asc ? aNum - bNum : bNum - aNum;
              return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });

            headers.forEach(h => h.classList.remove('asc', 'desc'));
            th.classList.add(asc ? 'asc' : 'desc');

            rows.forEach((row, i) => {
              if (row.children[0]) row.children[0].textContent = i + 1;
            });

            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));
          });
        });
      }

      // =====================================================================================
      // RENDER — MAIN LEADERBOARD (Everything)
      // =====================================================================================
      function renderLeaderboard(data, displayNameMap, teamTagMap) {
        const list = [...(data || [])].map(r => {
          const slug = String(r.username || '');
          const key = slug.toLowerCase();

          // Prefer API display name when available; fallback to data.displayName or slug
          const displayName = displayNameMap?.get(key) || String(r.displayName || slug);

          // Prefer data tag; fallback to API teamTag
          const tagEnrich = teamTagMap?.get(key) || '';
          const tag = String(r.tag || tagEnrich || '');

          return {
            displayName,
            username: slug,
            tag,
            title: String(r.title || ''),
            racesPlayed: safeNumber(r.racesPlayed),
            avgSpeed: safeNumber(r.avgSpeed),
            highestSpeed: safeNumber(r.highestSpeed),
            profileViews: safeNumber(r.profileViews),
            joinDate: String(r.joinDate || ''),
            garageCars: safeNumber(r.garageCars),
            membership: String(r.membership || ''),
            profileURL: String(r.profileURL || ntRacerURL(slug)),
            nitrosUsed: safeNumber(r.nitrosUsed),
            longestSession: safeNumber(r.longestSession),
            leagueTier: safeNumber(r.leagueTier)
          };
        });

        // Default sort: Total Races desc
        list.sort((a, b) => b.racesPlayed - a.racesPlayed);

        const tbody = document.querySelector('#leaderboardTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        const frag = document.createDocumentFragment();
        list.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Rank">${i + 1}</td>
            <td data-label="Display Name">
              <a class="link-quiet" href="${escapeAttr(ntRacerURL(r.username))}" target="_blank" rel="noopener noreferrer">${escapeHTML(r.displayName)}</a>
            </td>
            <td data-label="Username">${escapeHTML(r.username)}</td>
            <td data-label="Team Tag">
              ${r.tag ? `<a class="tag-link" href="${escapeAttr(ntTeamURL(r.tag))}" target="_blank" rel="noopener noreferrer">${escapeHTML(r.tag)}</a>` : '<span>-</span>'}
            </td>
            <td data-label="Title">${escapeHTML(r.title)}</td>
            <td data-label="Total Races" class="num">${r.racesPlayed.toLocaleString()}</td>
            <td data-label="Avg WPM" class="num">${r.avgSpeed.toLocaleString()}</td>
            <td data-label="Top WPM" class="num">${r.highestSpeed.toLocaleString()}</td>
            <td data-label="Profile Views" class="num">${r.profileViews.toLocaleString()}</td>
            <td data-label="Member Since">${escapeHTML(r.joinDate)}</td>
            <td data-label="Garage Cars" class="num">${r.garageCars.toLocaleString()}</td>
            <td data-label="Membership">${escapeHTML(r.membership)}</td>
            <td data-label="Profile URL">
              ${r.profileURL ? `<a class="link-quiet" href="${escapeAttr(r.profileURL)}" target="_blank" rel="noopener noreferrer">View Profile</a>` : '<span>-</span>'}
            </td>
            <td data-label="Nitros Used" class="num">${r.nitrosUsed.toLocaleString()}</td>
            <td data-label="Longest Session" class="num">${r.longestSession.toLocaleString()}</td>
            <td data-label="League Tier" class="num">${r.leagueTier.toLocaleString()}</td>
          `.trim();
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);

        const note = document.getElementById('leaderboardNote');
        if (note) note.textContent = `${list.length.toLocaleString()} racers loaded.`;
      }

      // =====================================================================================
      // RENDER — RACES PER DAY (with Join Date)
      // =====================================================================================
      function renderRacesPerDay(data, displayNameMap) {
        const now = Date.now();
        const list = (data || []).map(r => {
          const slug = String(r.username || '');
          const key = slug.toLowerCase();
          const displayName = displayNameMap?.get(key) || String(r.displayName || slug);

          const joined = parseLocalDate(r.joinDate).getTime();
          const days = Math.max(1, Math.floor((now - joined) / 86400000));
          const total = safeNumber(r.racesPlayed);

          return {
            displayName,
            username: slug,
            total,
            days,
            perDay: total / days,
            joinDate: String(r.joinDate || '')
          };
        }).sort((a, b) => b.perDay - a.perDay);

        const tbody = document.querySelector('#racesPerDayTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        const frag = document.createDocumentFragment();
        list.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
           
